---
title: "Large-scale machine-learning"
author: "Arthur Katossky & Rémi Pépin"
date: "January 2020"
subtitle: Tutorial 1 — How to optimize a statistical algorithm?
institute: ENSAI (Rennes, France)
---

<!--
TO DO:
[ ] add title
[ ] add sample section
[ ] merge the two pages into one
[ ] change "sliding mean" to "moving average"
[ ] test tutorial
[ ] add outline
[ ] clean up Remi's code
[ ] longer sample section
-->

# Introduction

In this tutorial, we will explore several ways to accelerate a slow statistical procedure.

We start with the following code. The procedure uses a database of monthly declaration by air carriers operating in the US, the _Air Carrier Statistics_ database, also known as the *T-100 data bank*. You do not need to bother dowloading the sources, but you will find additionnal information at this link: https://www.transtats.bts.gov/DatabaseInfo.asp?DB_ID=111.

Considering that each observation in this database is a flight (it is not _exactly_ the case, but it does not matter here), the overall goal of the script is to compute :

- the overall number of flights per month
- the average number of passengers with a moving-window of 5, then 10 days
- a rolling-regression, explaining payload with seats, passengers, freight, mail, distance

_**Disclaimer:** the original data have been altered for the purpose of the tutorial ; specifically, a day variable has been created *ex nihilo*._

# 1. The procedure to optimize

## 1.a Libraries
```{r message=FALSE, warning=FALSE}
library(dplyr)
library(RPostgreSQL)
```


## 1.b Open a connection with the databse

```{r}
pw <- "YojCqLr3Cnlw6onuzHU3" # Do not change the password !

drv <- dbDriver("PostgreSQL") # loads the PostgreSQL driver.
                              # (Needed to query the data)

# This is the proper connection.
# The same object will be used each time we want to connect to the database.
con <- dbConnect(drv, dbname = "postgres",
                 host = "database-1.c5bqsgv9tnea.eu-west-3.rds.amazonaws.com", port = 5432,
                 user = "postgres", password = pw)

rm(pw) # We don't need the password anymore.

dbExistsTable(con, "flight") # Check whether the "flight" table exist.
```

## 1.c Collect actual data set

```{r echo=FALSE}
FLIGHTS <- dbGetQuery(con, "SELECT * FROM flight LIMIT 1000")
FLIGHTS <- as_tibble(FLIGHTS)
FLIGHTS
```

```{r, eval=FALSE}
# Query all the data of the flight database
FLIGHTS <- dbGetQuery(con, "SELECT * FROM flight")
FLIGHTS
```

## 1.d Flight number per month

```{r}
COUNTS <- data.frame(
  year  = integer(),
  month = integer(), 
  count = integer()
)

n <- 0

for (i in 1:nrow(FLIGHTS)) {
  
  flight    <- FLIGHTS[i,]
  selection <- COUNTS$year == flight$year & COUNTS$month == flight$month
  
  if(nrow(COUNTS[selection,]) > 0) {
    
    COUNTS[selection, "count"] <- COUNTS[selection, "count"]+1
    
  }else{
    
    n <- n+1
    
    COUNTS[n, "year"]  <- flight$year
    COUNTS[n, "month"] <- flight$month
    COUNTS[n, "count"] <- 1
  }
}
```

```{r}
COUNTS # just a sample is shown
```

## 1.e Rolling average of the number of passengers, with a window of 5 and 10 days

```{r}
PASSENGERS_adjusted <- tibble()

# Passengers per day
PASSENGERS <- FLIGHTS %>% 
  group_by (year, month, day) %>%
  summarise (passengers = sum(passengers)) %>%
  arrange(year, month, day)

# 5-days rolling average. Begins at day 5.
for (i in 5:nrow(PASSENGERS)) {
  
  n <- 0
  for(j in (i-4):i) n <- n + PASSENGERS$passengers[j]
  
  new_row <- tibble(
    year          = PASSENGERS$year[i],
    month         = PASSENGERS$month[i],
    day           = PASSENGERS$day[i],
    passengers    = PASSENGERS$passengers[i],
    passengers_w5 = n/5
  )
  
  PASSENGERS_adjusted <- bind_rows(PASSENGERS_adjusted, new_row)
}

# 10-days rolling average. Begins at day 10.
for (i in 10:nrow(PASSENGERS)) {
  
  n <- 0
  for(j in (i-9):i) n <- n + PASSENGERS$passengers[j]
  
  PASSENGERS_adjusted[i-5, "passengers_w10"] <- n/10
}
```

```{r}
PASSENGERS_adjusted
```

## 1.f Rolling regression

A rolling regression is just a regression smoothed over time, exactly as the moving average is a smoothed version of the average. The regression is done on a moving windows of 1000 flights.

This regression explores the relationship between the payload on one hand, and on ther other hand number of seats, the mumber of transported passengers, the quantity of freight and mail transported and the flight distance.

_**Disclaimer:** do not try to make too much sense of this regression. We came short of a better exemple with the correct complexity balance._

```{r}

variables <- c("seats", "passengers", "freight", "mail", "distance")
betas     <- numeric()
FLIGHTS   <- FLIGHTS %>% arrange(year, month, day)

for (i in 1000:nrow(FLIGHTS)) {
  X <- data.matrix(FLIGHTS[(i-999):i, variables])
  X <- cbind(intercept=1, X)
  Y <- matrix(FLIGHTS$payload[(i-999):i], nrow = 1000, ncol = 1)
  betas <- rbind(betas, solve(t(X)%*% X) %*% t(X) %*% Y)
}
colnames(betas) <- c("seats", "passengers", "freight", "mail", "distance")

```
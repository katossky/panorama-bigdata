---
title: "R Notebook"
output: html_notebook
---
```{r}
library(dplyr)
library(RPostgreSQL)

```

# TP1 : Air Carrier Statistics domestic segment database analysis

In this practical session you will manipulate the Air Carrier Statistics database, also known as the *T-100 data bank*. You can fin the initial sources here : https://www.transtats.bts.gov/Fields.asp (no need to download the sources. They have been a alterned for the purpose of this session)

In this session, you have to optimise the follows script which compute :
- the number of flights per month
- the mean number of seat on sliding windows of 5 and 10 days
- the kernel regression to explain payload with seats, passengers, freight, mail, distance


## Data acquisition
```{r}
# create a connection. Do not change the pw !
pw <- "YojCqLr3Cnlw6onuzHU3"
 
# loads the PostgreSQL driver. Needed to query the data
drv <- dbDriver("PostgreSQL")

# note that "con" will be used later in each connection to the database. No need to create another
con <- dbConnect(drv, dbname = "postgres",
                 host = "database-1.c5bqsgv9tnea.eu-west-3.rds.amazonaws.com", port = 5432,
                 user = "postgres", password = pw)
rm(pw) # removes the password

# Check if the flight table exist
dbExistsTable(con, "flight")
```


On récupère les données
```{r echo=FALSE}
# Query all the data of the flight database
df_flight <- dbGetQuery(con, "SELECT * FROM flight LIMIT 10000")
```
```{r, eval=FALSE}
# Query all the data of the flight database
df_flight <- dbGetQuery(con, "SELECT * FROM flight")
```


## Flight number per month

```{r}
df_count = data.frame(year=integer(),
                 month=integer(), 
                 count=integer())

for (i in 1:nrow(df_flight)) {
  flight <- df_flight[i,]
  if(flight$month  %in% filter(df_count, year == flight$year)$month) {
      df_count$count[df_count$year==flight$year & df_count$month==flight$month ] = df_count$count[df_count$year==flight$year & df_count$month==flight$month ] +1
    }else {
       df_count[nrow(df_count) + 1,]= c(flight$year,flight$month, 1)
    }
}
```




## Sliding mean of passengers for 5 and 10 days

```{r}
df_moyenne_glissante_passager = data.frame(year=integer(),
                 month=integer(),
                 day=integer(),
                 moyenne_5=integer(),
                 moyenne_10=integer())


# Sum of passengers per day
df_sum_passenger <- df_flight %>% 
                        group_by (year, month, day) %>%
                        summarise (total_passager = sum(passengers)) %>%
                        arrange(year, month, day)

# Sliding 5 days mean. Begins at day 5
for (i in 5:nrow(df_sum_passenger)) {
  nombre_passager_glissant <- 0
  for(j in (i-4):i) {
    flight <- df_sum_passenger[j,]
    nombre_passager_glissant <- nombre_passager_glissant + flight$total_passager
  }
  moyenne_glissante_passager <- nombre_passager_glissant/5
  new_row <- data.frame(year=df_sum_passenger[i,]$year,
                 month=df_sum_passenger[i,]$month,
                 day=df_sum_passenger[i,]$day,
                 moyenne_5=moyenne_glissante_passager,
                 moyenne_10=NA)
 df_moyenne_glissante_passager <- df_moyenne_glissante_passager %>%rbind(new_row)
}


# Sliding 10 days mean. Begins at day 10
for (i in 10:nrow(df_sum_passenger)) {
  nombre_passager_glissant <- 0
  for(j in (i-9):i) {
    flight <- df_sum_passenger[j,]
    nombre_passager_glissant <- nombre_passager_glissant + flight$total_passager
  }
  moyenne_glissante_passager <- nombre_passager_glissant/10
 df_moyenne_glissante_passager[i-4,"moyenne_10"] <-moyenne_glissante_passager
  
}

```

## Kernel regression

Kernel regression : https://en.wikipedia.org/wiki/Kernel_regression

This regression explain the payload of each flight with i seats number, passengers number, freight transported , mail transported and distance. The regression is done on a sliding windows of 1000 flights.

```{r}
betas <- numeric()
df_flight <- df_flight %>% arrange(year, month, day)

for (i in 1000:nrow(df_flight)) {
 X <-  df_flight[(i-999):i,] %>%
      select(seats, passengers, freight, mail, distance) %>%
      data.matrix()
X <- cbind(matrix(1, nrow = 1000, ncol = 1), X)
Y <- matrix(df_flight[(i-999):i,]$payload, nrow = 1000, ncol = 1)

betas <- rbind(betas,solve(t(X)%*% X) %*% t(X) %*% Y)
  
}
colnames(betas) <- c("seats", "passengers", "freight", "mail", "distance")

```






















